<%= content_for :page_title, "Listings" %>

<%# ── Page Header ─────────────────────────────────────────── %>
<div class="admin-page-header d-flex flex-wrap justify-content-between align-items-end gap-3">
  <div>
    <h1>Listings</h1>
    <p class="subtitle">Quản lý toàn bộ bài đăng sản phẩm</p>
  </div>

  <%= form_with url: admin_listings_path, method: :get, local: true, class: "admin-search" do %>
    <input name="q" value="<%= @q %>" class="admin-input" placeholder="Tìm theo tiêu đề..." style="min-width:240px;">
    <button class="admin-btn admin-btn-outline" type="submit">
      <i class="bi bi-search"></i> Tìm
    </button>
  <% end %>
</div>

<%# ── Table Card ──────────────────────────────────────────── %>
<div class="admin-card">
  <div class="admin-card-header">
    <span class="admin-card-title">
      <i class="bi bi-tag me-1"></i>
      Danh sách
      <span class="ms-2 admin-badge na"><%= @listings.respond_to?(:total_count) ? @listings.total_count : @listings.size %> mục</span>
    </span>
  </div>

  <div class="table-responsive">
    <table class="admin-table">
      <thead>
        <tr>
          <th style="width:76px;">Ảnh</th>
          <th>Listing</th>
          <th>Seller</th>
          <th>Giá</th>
          <th>AI</th>
          <th>Trạng thái</th>
          <th class="text-end">Hành động</th>
        </tr>
      </thead>

      <tbody>
        <% @listings.each do |l| %>
          <tr>
            <td>
              <% if l.images.attached? %>
                <%= image_tag l.images.first, style: "width:52px;height:52px;object-fit:cover;border-radius:8px;" %>
              <% else %>
                <div style="width:52px;height:52px;border-radius:8px;background:#f1f5f9;border:1px solid #e2e8f0;"></div>
              <% end %>
            </td>

            <td>
              <div class="fw-semibold" style="color:#1e293b;">
                <%= link_to l.title, admin_listing_path(l), style: "color:inherit;text-decoration:none;" %>
              </div>
              <div style="font-size:12px;color:#94a3b8;margin-top:2px;">
                #<%= l.id %> · <%= l.category&.name.presence || "—" %> · <%= l.condition.presence || "—" %>
              </div>
            </td>

            <td>
              <div class="fw-semibold" style="font-size:13.5px;"><%= l.user&.name || "—" %></div>
              <div style="font-size:12px;color:#94a3b8;"><%= l.user&.email || "—" %></div>
            </td>

            <td style="font-size:13px;">
              <div><span style="color:#94a3b8;font-size:11.5px;">Start:</span> <%= number_to_currency(l.start_price, unit: "₫", format: "%n %u", separator: ".", delimiter: ",") rescue (l.start_price || "—") %></div>
              <div><span style="color:#94a3b8;font-size:11.5px;">Buy now:</span>
                <%= l.buy_now_enabled? ? (number_to_currency(l.buy_now_price, unit: "₫", format: "%n %u", separator: ".", delimiter: ",") rescue (l.buy_now_price || "—")) : "off" %>
              </div>
            </td>

            <td>
              <span class="admin-badge na">
                <%= l.respond_to?(:ai_status) ? (l.ai_status || "n/a") : "n/a" %>
              </span>
            </td>

            <td>
              <% if l.blocked? %>
                <span class="admin-badge blocked"><i class="bi bi-slash-circle me-1"></i>Blocked</span>
              <% elsif l.published_at.present? %>
                <span class="admin-badge published"><i class="bi bi-check-circle me-1"></i>Published</span>
                <div style="font-size:11px;color:#94a3b8;margin-top:2px;"><%= l.published_at.strftime("%d/%m %H:%M") %></div>
              <% else %>
                <span class="admin-badge draft"><i class="bi bi-clock me-1"></i>Draft</span>
              <% end %>
            </td>

            <td>
              <div class="d-flex justify-content-end gap-2">
                <%= link_to admin_listing_path(l), class: "admin-btn admin-btn-outline admin-btn-sm" do %>
                  <i class="bi bi-eye"></i> Xem
                <% end %>

                <% if l.blocked? %>
                  <%= button_to unblock_admin_listing_path(l),
                        method: :patch,
                        form: { class: "d-inline" },
                        class: "admin-btn admin-btn-success admin-btn-sm",
                        data: { turbo_confirm: "Bỏ chặn sản phẩm này?" } do %>
                    <i class="bi bi-unlock"></i> Unblock
                  <% end %>
                <% else %>
                  <%= button_to block_admin_listing_path(l),
                        method: :patch,
                        form: { class: "d-inline" },
                        class: "admin-btn admin-btn-danger admin-btn-sm",
                        data: { turbo_confirm: "⚠️ Chặn sản phẩm này?" } do %>
                    <i class="bi bi-slash-circle"></i> Block
                  <% end %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>

        <% if @listings.blank? %>
          <tr>
            <td colspan="7" style="text-align:center;color:#94a3b8;padding:40px 0;">
              <i class="bi bi-inbox" style="font-size:28px;display:block;margin-bottom:8px;"></i>
              Không có listing nào.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div style="padding:16px 20px;display:flex;justify-content:center;">
    <%= paginate @listings %>
  </div>
</div>
