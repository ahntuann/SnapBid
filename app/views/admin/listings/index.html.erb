<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-end gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1">Listings</h1>
      <div class="text-muted">Quản lý bài đăng</div>
    </div>

    <%= form_with url: admin_listings_path, method: :get, local: true, class: "d-flex gap-2" do %>
      <input name="q" value="<%= @q %>" class="form-control" placeholder="Tìm theo tiêu đề..." style="min-width:260px;">
      <button class="btn btn-outline-primary">Search</button>
    <% end %>
  </div>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:84px;">Ảnh</th>
            <th>Listing</th>
            <th class="text-nowrap">Seller</th>
            <th class="text-nowrap">Giá</th>
            <th class="text-nowrap">AI</th>
            <th class="text-nowrap">Publish</th>
            <th class="text-end text-nowrap">Hành động</th>
          </tr>
        </thead>

        <tbody>
          <% @listings.each do |l| %>
            <tr>
              <td>
                <% if l.images.attached? %>
                  <%= image_tag l.images.first, class: "rounded", style: "width:64px;height:64px;object-fit:cover;" %>
                <% else %>
                  <div class="rounded bg-light border" style="width:64px;height:64px;"></div>
                <% end %>
              </td>

              <td>
                <div class="fw-semibold">
                  <%= link_to l.title, admin_listing_path(l), class: "text-decoration-none" %>
                </div>
                <div class="text-muted small">
                  <%= l.id %> • <%= l.category&.name.presence || "—" %> • <%= l.condition.presence || "-" %>
                </div>
              </td>

              <td class="text-nowrap">
                <div class="fw-semibold"><%= l.user&.name || "-" %></div>
                <div class="text-muted small"><%= l.user&.email || "-" %></div>
              </td>

              <td class="text-nowrap">
                <div><span class="text-muted small">Start:</span> <%= l.start_price || "-" %></div>
                <div><span class="text-muted small">Buy now:</span> <%= l.buy_now_enabled? ? (l.buy_now_price || "-") : "off" %></div>
              </td>

              <td class="text-nowrap">
                <%# tuỳ dự án: ai_status / verified? %>
                <span class="badge bg-secondary"><%= l.respond_to?(:ai_status) ? (l.ai_status || "n/a") : "n/a" %></span>
              </td>

              <td class="text-nowrap">
                <% if l.blocked? %>
                  <span class="badge bg-danger">blocked</span>
                <% elsif l.published_at.present? %>
                  <span class="badge bg-success">published</span>
                  <div class="text-muted small">
                    <%= l.published_at.strftime("%d/%m %H:%M") %>
                  </div>
                <% else %>
                  <span class="badge bg-warning text-dark">draft</span>
                <% end %>
              </td>

              <td class="text-end text-nowrap">
                <div class="d-inline-flex align-items-center gap-2">
                  <%= link_to admin_listing_path(l),
                        class: "btn btn-sm btn-outline-secondary d-flex justify-content-center align-items-center",
                        style: "min-width:86px" do %>
                    Show
                  <% end %>

                  <% if l.blocked? %>
                    <%= button_to unblock_admin_listing_path(l),
                          method: :patch,
                          form: { class: "d-inline" },
                          class: "btn btn-sm btn-success d-flex justify-content-center align-items-center",
                          style: "min-width:86px",
                          data: { turbo_confirm: "Bỏ chặn sản phẩm này?" } do %>
                      <i class="bi bi-unlock me-1"></i> Unblock
                    <% end %>
                  <% else %>
                    <%= button_to block_admin_listing_path(l),
                          method: :patch,
                          form: { class: "d-inline" },
                          class: "btn btn-sm btn-danger d-flex justify-content-center align-items-center",
                          style: "min-width:86px",
                          data: { turbo_confirm: "⚠️ Chặn sản phẩm này?" } do %>
                      <i class="bi bi-slash-circle me-1"></i> Block
                    <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <% if @listings.blank? %>
            <tr>
              <td colspan="7" class="text-center text-muted py-4">Không có listing nào.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="card-body d-flex justify-content-center">
      <%= paginate @listings %>
    </div>
  </div>
</div>
