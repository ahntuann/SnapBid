<%= content_for :page_title, "Orders" %>

<div class="admin-page-header d-flex flex-wrap justify-content-between align-items-end gap-3">
  <div>
    <h1>Orders</h1>
    <p class="subtitle">Danh sách đơn hàng cần xác nhận</p>
  </div>

  <%= form_with url: admin_orders_path, method: :get, local: true, class: "admin-search" do %>
    <%= select_tag :kind,
          options_for_select([["Tất cả loại", ""], ["auction_win", "auction_win"], ["buy_now", "buy_now"]], params[:kind]),
          class: "admin-input", onchange: "this.form.requestSubmit()" %>

    <%= select_tag :status,
          options_for_select([["Tất cả trạng thái", ""], ["pending", "pending"], ["paid", "paid"], ["cancelled", "cancelled"]], params[:status]),
          class: "admin-input", onchange: "this.form.requestSubmit()" %>

    <%= link_to admin_orders_path, class: "admin-btn admin-btn-outline" do %>
      <i class="bi bi-arrow-counterclockwise"></i> Reset
    <% end %>
  <% end %>
</div>

<div class="admin-card">
  <div class="admin-card-header">
    <span class="admin-card-title"><i class="bi bi-bag-check me-1"></i> Đơn hàng</span>
  </div>

  <div class="table-responsive">
    <table class="admin-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Listing / Buyer</th>
          <th>Loại</th>
          <th>Trạng thái</th>
          <th>Đã chuyển tiền</th>
          <th class="text-end">Giá</th>
          <th class="text-end">Hành động</th>
        </tr>
      </thead>
      <tbody>
        <% @orders.each do |o| %>
          <tr>
            <td style="color:#94a3b8;font-weight:600;">#<%= o.id %></td>

            <td>
              <div class="fw-semibold" style="color:#1e293b;"><%= o.listing&.title %></div>
              <div style="font-size:12px;color:#94a3b8;">Buyer: <%= o.buyer&.name %></div>
            </td>

            <td><span class="admin-badge na"><%= o.kind %></span></td>

            <td>
              <% badge_class = case o.status
                when "paid"      then "paid"
                when "cancelled" then "na"
                else "pending"
                end %>
              <span class="admin-badge <%= badge_class %>"><%= o.status %></span>
            </td>

            <td>
              <% if o.buyer_marked_paid? %>
                <span class="admin-badge published">Đã chuyển</span>
                <div style="font-size:11px;color:#94a3b8;"><%= l(o.buyer_marked_paid_at, format: :short) rescue "" %></div>
              <% else %>
                <span class="admin-badge na">Chưa</span>
              <% end %>
            </td>

            <td class="text-end fw-semibold" style="color:#1e293b;">
              <%= number_to_currency(o.price, unit: "₫", precision: 0) rescue o.price %>
            </td>

            <td class="text-end">
              <%= link_to admin_order_path(o), class: "admin-btn admin-btn-primary admin-btn-sm" do %>
                <i class="bi bi-eye"></i> Xem
              <% end %>
            </td>
          </tr>
        <% end %>

        <% if @orders.blank? %>
          <tr>
            <td colspan="7" style="text-align:center;color:#94a3b8;padding:40px 0;">
              <i class="bi bi-bag" style="font-size:28px;display:block;margin-bottom:8px;"></i>
              Không có đơn hàng nào.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div style="padding:16px 20px;display:flex;justify-content:center;">
    <%= paginate @orders %>
  </div>
</div>
