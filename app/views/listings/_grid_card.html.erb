<%# ===== Helpers (fallback field names) ===== %>
<% title = listing.try(:title) || listing.try(:name) || "Sản phẩm" %>
<% ends_at = listing.try(:ends_at) || listing.try(:end_time) || listing.try(:auction_ends_at) %>
<% created_at = listing.try(:created_at) %>

<% current_price =
     listing.try(:current_price) ||
     listing.try(:price_current) ||
     listing.try(:current_bid) ||
     listing.try(:price) ||
     listing.try(:starting_price) %>

<% watchers =
     listing.try(:watchers_count) ||
     listing.try(:favorites_count) ||
     listing.try(:interests_count) ||
     0 %>

<%# status flags %>
<% now = Time.current %>
<% ended = ends_at.present? && ends_at <= now %>
<% ending_soon = ends_at.present? && !ended && ends_at <= now + 1.hour %>
<% is_new = created_at.present? && created_at >= now - 24.hours %>

<div class="col-6 col-md-4 col-lg-3">
  <div class="card h-100 shadow-sm home-card <%= "opacity-75" if ended %>">
    <a href="<%= polymorphic_path(listing) %>" class="text-decoration-none text-dark">
      <div class="position-relative">
        <div class="ratio ratio-1x1 bg-body-tertiary">
          <%# ==== Image fallback: sử dụng hình ảnh đầu tiên từ danh sách images ==== %>
          <% if listing.images.attached? %>
            <%= image_tag listing.images.first, 
                          class: "w-100 h-100 object-fit-cover",
                          loading: "lazy",
                          alt: title %>
          <% elsif listing.respond_to?(:cover_image_url) && listing.cover_image_url.present? %>
            <%= image_tag listing.cover_image_url,
                          class: "w-100 h-100 object-fit-cover",
                          loading: "lazy",
                          alt: title %>
          <% else %>
            <div class="d-flex align-items-center justify-content-center text-muted small">
              Không có ảnh
            </div>
          <% end %>
        </div>

        <div class="position-absolute top-0 start-0 p-2 d-flex flex-wrap gap-1">
          <% if ended %>
            <span class="badge text-bg-secondary">Đã kết thúc</span>
          <% elsif ending_soon %>
            <span class="badge text-bg-danger">Sắp kết thúc</span>
          <% end %>

          <% if is_new && !ended %>
            <span class="badge text-bg-primary">Mới</span>
          <% end %>
        </div>

        <div class="position-absolute top-0 end-0 p-2">
          <span class="badge bg-dark bg-opacity-75">
            <i class="bi bi-heart-fill me-1"></i><%= watchers.to_i %>
          </span>
        </div>
      </div>

      <div class="card-body p-3">
        <div class="fw-semibold lh-sm mb-2 home-card-title"><%= title %></div>

        <div class="d-flex align-items-end justify-content-between gap-2">
          <div>
            <div class="text-muted small">Giá hiện tại</div>
            <div class="fs-6 fw-bold">
              <% if current_price.present? %>
                <%= number_to_currency(current_price, unit: "₫", precision: 0, format: "%n%u") %>
              <% else %>
                <span class="text-muted">—</span>
              <% end %>
            </div>
          </div>

          <div class="text-end">
            <div class="text-muted small">Kết thúc</div>

            <%# Countdown (Stimulus) %>
            <div class="fw-semibold <%= "text-danger" if ending_soon %>"
                 data-controller="countdown"
                 data-countdown-end-at-value="<%= ends_at&.iso8601 %>">
              <span data-countdown-target="label">
                <% if ends_at.present? %>
                  <%= l(ends_at, format: :short) rescue ends_at.strftime("%d/%m %H:%M") %>
                <% else %>
                  —
                <% end %>
              </span>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex align-items-center justify-content-between">
          <div class="small text-muted">
            <i class="bi bi-eye me-1"></i> Xem chi tiết
          </div>
          <span class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-right"></i>
          </span>
        </div>
      </div>
    </a>
  </div>
</div>
