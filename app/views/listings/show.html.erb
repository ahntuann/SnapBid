<div
  data-controller="listing"
  data-listing-id-value="<%= @listing.id %>"
  data-listing-buy-now-enabled-value="<%= @listing.buy_now_enabled? %>"
  data-listing-buy-now-price-value="<%= (@listing.buy_now_price || 0).to_i %>"
  data-listing-auction-ends-at-value="<%= @listing.auction_ends_at&.iso8601 %>"
>
  <!-- Flash realtime (stimulus sẽ fill) -->
  <div data-listing-target="flash" class="d-none mb-3 alert" role="alert"></div>

  <!-- Breadcrumb -->
  <nav class="small text-muted mb-3">
    <%= link_to "Home", root_path, class: "text-decoration-none" %>
    <span class="mx-1">/</span>
    <%= link_to(@listing.category.presence || "Danh mục", "#", class: "text-decoration-none") %>
  </nav>

  <div class="row g-4">
    <!-- LEFT: Title + Gallery + Description -->
    <div class="col-12 col-lg-7">
      <h1 class="h3 fw-semibold mb-2"><%= @listing.title %></h1>

      <div class="text-muted mb-3">
        <span class="me-2"><b>Danh mục:</b> <%= @listing.category.presence || "-" %></span>
        <span class="text-muted">|</span>
        <span class="ms-2"><b>Tình trạng:</b> <%= @listing.condition.presence || "-" %></span>
      </div>

      <!-- Gallery (ảnh lớn + thumbnails) -->
      <div data-controller="gallery">
        <div class="rounded-4 border bg-white overflow-hidden position-relative">
          
          <div class="position-absolute top-0 end-0 p-3" style="z-index: 10;">
            <% if @listing.ai_verified? %>
              <span class="badge bg-success bg-opacity-75 backdrop-blur shadow py-2 px-3 border border-success border-opacity-25">
                <i class="bi bi-stars me-1"></i> Xác minh bởi AI
              </span>
            <% else %>
              <span class="badge bg-secondary bg-opacity-75 backdrop-blur shadow py-2 px-3">
                <i class="bi bi-shield-exclamation me-1"></i> Chưa xác minh
              </span>
            <% end %>
          </div>

          <div class="ratio ratio-4x3 bg-light">
            </div>
        </div>
          <div class="ratio ratio-4x3 bg-light">
            <% if @listing.images.attached? %>
              <img
                data-gallery-target="main"
                src="<%= url_for(@listing.images.first) %>"
                class="w-100 h-100 object-fit-cover"
                alt="Ảnh sản phẩm"
              >
            <% else %>
              <div class="d-flex align-items-center justify-content-center text-muted">
                Chưa có ảnh
              </div>
            <% end %>
          </div>
        </div>

        <% if @listing.images.attached? %>
          <div class="d-flex gap-2 mt-3 flex-wrap">
            <% @listing.images.each_with_index do |img, idx| %>
              <button
                type="button"
                class="p-0 border rounded-3 overflow-hidden bg-white gallery-thumb <%= "active" if idx == 0 %>"
                data-action="click->gallery#pick"
                data-gallery-url="<%= url_for(img) %>"
                aria-label="Chọn ảnh <%= idx + 1 %>"
              >
                <img src="<%= url_for(img) %>" alt="thumb" class="w-100 h-100 object-fit-cover">
              </button>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Description -->
      <div class="mt-4">
        <div class="text-uppercase small fw-semibold text-muted mb-2">Mô tả</div>
        <div class="bg-white border rounded-4 p-3">
          <%= simple_format(@listing.seller_note.to_s) %>
        </div>
      </div>
    </div>

    <!-- RIGHT: Auction card + actions -->
    <div class="col-12 col-lg-5">
      <div class="bg-white border rounded-4 p-3 p-md-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-muted">Giá hiện tại</div>
            <div class="h4 mb-0 fw-semibold">
              <span data-listing-target="currentPrice"><%= @listing.current_price %></span>
            </div>
          </div>

          <span class="badge <%= @listing.sold? ? "text-bg-success" : (@listing.auction_ended? ? "text-bg-secondary" : "text-bg-primary") %>">
            <span data-listing-target="status">
              <% if @listing.sold? %>
                Đã bán
              <% elsif @listing.auction_ended? %>
                Đã kết thúc
              <% else %>
                Đang diễn ra
              <% end %>
            </span>
          </span>
        </div>

        <hr class="my-4">

        <div class="text-uppercase small fw-semibold text-muted mb-2">Thông tin đấu giá</div>
        <div class="row g-3 small">
          <div class="col-6">
            <div class="text-muted">Giá khởi điểm</div>
            <div class="fw-semibold"><%= @listing.start_price.presence || "-" %></div>
          </div>
          <div class="col-6">
            <div class="text-muted">Giá hiện tại</div>
            <div class="fw-semibold"><span data-listing-target="currentPrice"><%= @listing.current_price %></span></div>
          </div>
          <div class="col-6">
            <div class="text-muted">Số lượt đặt</div>
            <div class="fw-semibold"><%= @listing.bids.count %></div>
          </div>
          <div class="col-6">
            <div class="text-muted">Kết thúc lúc</div>
            <div class="fw-semibold"><%= @listing.auction_ends_at ? l(@listing.auction_ends_at, format: :short) : "-" %></div>
          </div>
        </div>

        <hr class="my-4">

        <!-- Bid + Buy now -->
        <% if user_signed_in? %>
          <% if !@listing.sold? && !@listing.auction_ended? %>
            <div data-listing-target="bidForm">
              <div class="text-uppercase small fw-semibold text-muted mb-2">Đặt giá</div>
              <div class="text-muted small mb-2">
                Giá tối thiểu tiếp theo: <b><%= @listing.min_next_bid %></b>
              </div>

              <%= form_with model: [@listing, @bid], local: true, data: { action: "submit->listing#submitBid" } do |f| %>
                <%= f.number_field :amount,
                      step: "0.01",
                      class: "form-control mb-2",
                      placeholder: "Nhập giá (tối thiểu #{@listing.min_next_bid})",
                      data: { listing_target: "amount", action: "input->listing#checkBuyNowThreshold" } %>

                <%= hidden_field_tag :confirm_buy_now, "0", data: { listing_target: "confirmBuyNow" } %>

                <%= f.submit t("buttons.place_bid"), class: "btn btn-primary w-100" %>
              <% end %>
            </div>

            <% if @listing.buy_now_enabled? %>
              <div data-listing-target="buyNowBox" class="mt-3">
                <div class="text-muted small mb-2">
                  Mua ngay: <b><%= @listing.buy_now_price %></b>
                </div>

                <%= button_to t("buttons.buy_now"),
                      buy_now_listing_path(@listing),
                      method: :post,
                      class: "btn btn-outline-secondary w-100",
                      data: { turbo_confirm: t("confirmations.buy_now") } %>
              </div>
            <% end %>
          <% else %>
            <div class="alert alert-secondary mb-0">
              Phiên này đã kết thúc hoặc sản phẩm đã bán.
            </div>
          <% end %>
        <% else %>
          <div class="alert alert-warning mb-0">
            <%= t("pages.listings.login_to_bid") %>
          </div>
        <% end %>
      </div>

      <!-- Recent bids -->
      <div class="bg-white border rounded-4 p-3 p-md-4 mt-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="text-uppercase small fw-semibold text-muted"><%= t("pages.listings.recent_bids") %></div>
          <div class="small text-muted"><%= @listing.bids.count %> lượt</div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Người đặt</th>
                <th>Giá</th>
                <th class="text-end">Thời gian</th>
              </tr>
            </thead>
            <tbody data-listing-target="bids">
              <% @listing.bids.order(created_at: :desc).limit(10).each do |bid| %>
                <tr>
                  <td class="text-truncate" style="max-width: 220px;"><%= bid.user.name.presence || bid.user.email %></td>
                  <td class="fw-semibold"><%= bid.amount %></td>
                  <td class="text-end text-muted"><%= l(bid.created_at, format: :short) %></td>
                </tr>
              <% end %>

              <% if @listing.bids.none? %>
                <tr>
                  <td colspan="3" class="text-muted text-center py-4">Chưa có lượt đặt giá nào</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="mt-3">
          <%= link_to t("buttons.back"), root_path, class: "btn btn-link px-0" %>
        </div>
      </div>
    </div>
  </div>
</div>
