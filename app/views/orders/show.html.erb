<div data-controller="order" data-order-id-value="<%= @order.id %>">
  <div class="mx-auto" style="max-width: 860px;">
    <h1 class="h3 fw-bold mb-4">Xác nhận đơn hàng</h1>

    <%# ===== CANCELLED ALERT (TOP) ===== %>
    <% if @order.cancelled? %>
      <div class="alert alert-danger mb-4">
        <% if @order.respond_to?(:cancelled_reason) && @order.cancelled_reason.to_s == "late_payment_3_days" %>
          Đơn Hàng đã bị Huỷ do bạn trễ hạn thanh toán quá 3 ngày.
        <% else %>
          Đơn Hàng đã bị Hệ thống của chúng tôi Huỷ do bạn trễ hạn thanh toán quá 3 ngày.
        <% end %>
      </div>
    <% end %>

    <!-- Product Information -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex align-items-start gap-3">
          <div class="flex-shrink-0">
            <% if @order.listing.images.attached? %>
              <%= image_tag @order.listing.images.first,
                class: "rounded border",
                style: "width:72px;height:72px;object-fit:cover;" %>
            <% else %>
              <div class="rounded border bg-light d-flex align-items-center justify-content-center"
                   style="width:72px;height:72px;">
                <i class="bi bi-image text-secondary"></i>
              </div>
            <% end %>
          </div>

          <div class="flex-grow-1">
            <div class="fw-semibold"><%= @order.listing.title %></div>
            <div class="text-muted small">
              Người bán:
              <%= @order.listing.user&.name.presence || @order.listing.user&.email %>
            </div>

            <div class="mt-2 d-flex flex-wrap gap-2">
              <span class="badge text-bg-light border">Mã đơn #<%= @order.id %></span>
              <span class="badge text-bg-light border">Loại: <%= @order.kind %></span>

              <%# status badge %>
              <% status_class =
                   if @order.cancelled?
                     "text-bg-danger"
                   elsif @order.paid?
                     "text-bg-success"
                   elsif @order.buyer_marked_paid?
                     "text-bg-warning"
                   else
                     "text-bg-secondary"
                   end %>

              <span class="badge <%= status_class %>">
                <span data-order-target="statusText"><%= @order.status %></span>
              </span>
            </div>
          </div>

          <div class="text-end">
            <div class="text-muted small">Giá</div>
            <div class="fw-bold">
              <%= number_to_currency(@order.price, unit: "₫", precision: 0, delimiter: ".", format: "%n %u") %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recipient Information -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="fw-semibold mb-3">Thông tin người nhận</div>

        <% if @order.pending? && !@order.cancelled? %>
          <%= form_with model: @order, url: order_path(@order), method: :patch, local: true do |f| %>
            <div class="row g-3">
              <div class="col-12">
                <%= f.label :recipient_name, "Họ tên", class: "form-label" %>
                <%= f.text_field :recipient_name, class: "form-control",
                      value: @order.recipient_name,
                      placeholder: "Nhập họ tên người nhận" %>
              </div>

              <div class="col-12 col-md-6">
                <%= f.label :recipient_phone, "Số điện thoại", class: "form-label" %>
                <%= f.text_field :recipient_phone, class: "form-control",
                      value: @order.recipient_phone,
                      placeholder: "VD: 09xxxxxxxx" %>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Trạng thái thông tin</label>
                <div class="border rounded px-3 py-2 bg-light">
                  <% if @order.shipping_info_complete? %>
                    <span class="text-success"><i class="bi bi-check-circle"></i> Đã đủ thông tin</span>
                  <% else %>
                    <span class="text-danger"><i class="bi bi-exclamation-circle"></i> Chưa đủ thông tin</span>
                  <% end %>
                </div>
              </div>

              <div class="col-12">
                <%= f.label :shipping_address, "Địa chỉ giao hàng", class: "form-label" %>
                <div class="position-relative">
                  <%= f.text_area :shipping_address, class: "form-control",
                        value: @order.shipping_address,
                        rows: 3,
                        placeholder: "Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành..." %>
                  <i class="bi bi-pencil position-absolute text-secondary"
                     style="right:12px;bottom:12px;"></i>
                </div>
              </div>

              <div class="col-12 d-flex justify-content-end">
                <%= f.submit "Lưu thông tin", class: "btn btn-primary", data: { turbo: false } %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="row g-2">
            <div class="col-12 col-md-4"><span class="text-muted">Họ tên:</span> <b><%= @order.recipient_name.presence || "-" %></b></div>
            <div class="col-12 col-md-4"><span class="text-muted">SĐT:</span> <b><%= @order.recipient_phone.presence || "-" %></b></div>
            <div class="col-12"><span class="text-muted">Địa chỉ:</span> <b><%= @order.shipping_address.presence || "-" %></b></div>
          </div>

          <% if @order.cancelled? %>
            <div class="text-muted small mt-3">
              Đơn hàng đã bị huỷ nên không thể cập nhật thông tin nhận hàng.
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Payment Details -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="fw-semibold mb-3">Chi tiết thanh toán</div>

        <% shipping_fee = 0 %>
        <% total = @order.price.to_d + shipping_fee.to_d %>

        <div class="d-flex justify-content-between py-1">
          <div class="text-muted">Giá sản phẩm</div>
          <div class="fw-semibold"><%= number_to_currency(@order.price, unit: "₫", precision: 0, delimiter: ".", format: "%n %u") %></div>
        </div>
        <div class="d-flex justify-content-between py-1">
          <div class="text-muted">Phí vận chuyển (tạm tính)</div>
          <div class="fw-semibold"><%= number_to_currency(shipping_fee, unit: "₫", precision: 0, delimiter: ".", format: "%n %u") %></div>
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between py-1">
          <div class="fw-semibold">Tổng cộng</div>
          <div class="fw-bold"><%= number_to_currency(total, unit: "₫", precision: 0, delimiter: ".", format: "%n %u") %></div>
        </div>
      </div>
    </div>

    <%# ===== Payment Method: hide when cancelled ===== %>
    <% unless @order.cancelled? %>
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="fw-semibold mb-2">Phương thức thanh toán</div>

          <div class="d-flex align-items-start gap-3 p-3 rounded border bg-light">
            <div class="rounded bg-white border d-flex align-items-center justify-content-center"
                 style="width:44px;height:44px;">
              <i class="bi bi-shield-check"></i>
            </div>
            <div class="flex-grow-1">
              <div class="fw-semibold">Trung gian qua hệ thống</div>
              <div class="text-muted small">Thanh toán an toàn qua trung gian SnapBid (chuyển khoản/QR)</div>

              <div class="mt-3">
                <div class="text-muted small mb-2">
                  Quét QR để chuyển khoản. Nội dung gợi ý: <b>ORDER <%= @order.id %></b>
                </div>

                <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-3">
                  <div class="bg-white rounded border p-2" style="width: 220px;">
                    <%= image_tag vietqr_image_url(
                          amount: @order.total_price,
                          add_info: "ORDER #{@order.id}"
                        ),
                        class: "img-fluid",
                        alt: "QR thanh toán VietQR" %>
                  </div>
                  <div class="flex-grow-1">
                    <div data-order-target="buyerSection" class="<%= 'd-none' if @order.paid? %>">
                      <% if @order.pending? %>
                        <% if @order.buyer_marked_paid? %>
                          <div class="alert alert-warning mb-0">
                            Bạn đã bấm xác nhận chuyển tiền lúc:
                            <b><%= l(@order.buyer_marked_paid_at, format: :short) %></b>.
                            Đang chờ admin xác nhận.
                          </div>
                        <% else %>
                          <% disabled = !@order.shipping_info_complete? %>

                          <%= button_to "Tôi đã chuyển tiền",
                                mark_paid_order_path(@order),
                                method: :post,
                                class: "btn btn-primary w-100 w-sm-auto",
                                disabled: disabled,
                                data: { turbo_confirm: "Bạn chắc chắn đã chuyển khoản cho đơn ##{@order.id}?" } %>

                          <% if disabled %>
                            <div class="text-danger small mt-2">
                              * Vui lòng nhập đầy đủ thông tin nhận hàng và bấm “Lưu thông tin” trước.
                            </div>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div>

                    <div data-order-target="doneSection" class="<%= @order.paid? ? '' : 'd-none' %>">
                      <div class="alert alert-success mb-0">
                        Đơn hàng đã được xác nhận thanh toán.
                      </div>
                    </div>

                    <div class="mt-3">
                      <%= link_to "Xem sản phẩm", listing_path(@order.listing), class: "link-primary text-decoration-none" %>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>
    <% end %>

    <div class="d-flex justify-content-start">
      <%= link_to "Quay lại", orders_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>
</div>
