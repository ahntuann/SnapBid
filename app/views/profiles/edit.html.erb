<div class="container" style="max-width: 900px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-1">Chỉnh sửa tài khoản</h1>
      <div class="text-muted">Cập nhật tên và avatar</div>
    </div>
    <%= link_to "Quay lại", profile_path, class: "btn btn-outline-secondary btn-sm" %>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">

      <%= form_with model: current_user,
            url: profile_path,
            method: :patch,
            local: true,
            multipart: true,
            data: { controller: "avatar-preview" } do |f| %>

        <!-- Email -->
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input class="form-control" value="<%= current_user.email %>" disabled>
        </div>

        <!-- Display name -->
        <div class="mb-3">
          <%= f.label :name, "Tên hiển thị", class: "form-label" %>
          <%= f.text_field :name,
                class: "form-control",
                placeholder: "VD: Phong" %>
        </div>

        <!-- Avatar upload -->
        <div class="mb-3">
          <label class="form-label">Avatar</label>

          <%= f.file_field :avatar,
                class: "form-control",
                accept: "image/*",
                data: {
                  avatar_preview_target: "input",
                  action: "change->avatar-preview#preview"
                } %>

          <div class="form-text">Chọn ảnh JPG/PNG.</div>

          <!-- Preview -->
          <div class="mt-3 d-flex align-items-center gap-3">
            <div class="rounded-circle border bg-light overflow-hidden"
                 style="width:72px;height:72px;">

              <img
                data-avatar-preview-target="img"
                src="<%= current_user.avatar.attached? ? url_for(current_user.avatar) : "" %>"
                style="width:72px;height:72px;object-fit:cover;<%= current_user.avatar.attached? ? "" : "display:none;" %>"
                alt="Avatar preview">

              <div data-avatar-preview-target="placeholder"
                   class="w-100 h-100 d-flex align-items-center justify-content-center text-muted"
                   style="<%= current_user.avatar.attached? ? "display:none;" : "" %>">
                <i class="bi bi-person fs-4"></i>
              </div>
            </div>

            <div class="small text-muted">
              <div class="fw-semibold">Xem trước avatar</div>
              <div data-avatar-preview-target="filename">
                <%= current_user.avatar.attached? ? current_user.avatar.filename.to_s : "Chưa có avatar" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2">
          <%= f.submit "Lưu", class: "btn btn-primary" %>
          <%= link_to "Huỷ", profile_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>

      <!-- Delete avatar (outside form) -->
      <% if current_user.avatar.attached? %>
        <div class="mt-3">
          <%= button_to "Xoá avatar",
                destroy_avatar_profile_path,
                method: :delete,
                class: "btn btn-outline-danger btn-sm",
                data: { turbo_confirm: "Xoá avatar và quay về mặc định?" } %>
        </div>
      <% end %>

    </div>
  </div>
</div>
