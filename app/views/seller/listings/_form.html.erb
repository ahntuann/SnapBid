<%= form_with model: listing, url: url, method: method, multipart: true do |f| %>
  <% if listing.errors.any? %>
    <div class="alert alert-danger">
      <div class="fw-semibold mb-1">Có lỗi:</div>
      <ul class="mb-0">
        <% listing.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row g-3">
    <!-- LEFT -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :title, "Tên sản phẩm", class: "form-label" %>
            <%= f.text_field :title, class: "form-control", placeholder: "VD: Túi xách vintage..." %>
          </div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <%= f.label :category, "Danh mục", class: "form-label" %>
              <%= f.text_field :category, class: "form-control", placeholder: "VD: Thời trang, Điện tử..." %>
            </div>
            <div class="col-12 col-md-6">
              <%= f.label :condition, "Tình trạng", class: "form-label" %>
              <%= f.select :condition,
                    options_for_select([["Mới", "new"], ["Đã sử dụng", "used"]], listing.condition),
                    { include_blank: "Chọn tình trạng" },
                    class: "form-select" %>
            </div>
          </div>

          <div class="mt-3">
            <%= f.label :seller_note, "Mô tả chi tiết", class: "form-label" %>
            <%= f.text_area :seller_note, rows: 6, class: "form-control", placeholder: "Mô tả sản phẩm và phụ kiện đi kèm..." %>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-1">Hình ảnh sản phẩm</div>
          <div class="text-muted small mb-3">Tối thiểu 1, tối đa 5 ảnh (có thể chọn nhiều ảnh).</div>
          <%= f.file_field :images, multiple: true, class: "form-control" %>

          <% if listing.images.attached? %>
            <hr>
            <div class="row g-2">
              <% listing.images.each do |img| %>
                <div class="col-4 col-md-3">
                  <%= image_tag img, class: "img-fluid rounded border" %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="fw-semibold mb-2">Thiết lập bán hàng</div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <%= f.label :start_price, "Giá khởi điểm (VND)", class: "form-label" %>
              <%= f.number_field :start_price, class: "form-control", step: "0.01", placeholder: "VD: 1000000" %>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :published_at, "Thời điểm đăng lên trang chủ (tuỳ chọn)", class: "form-label" %>
              <%= f.datetime_local_field :published_at, class: "form-control" %>
              <div class="form-text">Để trống nếu chưa muốn hiển thị ở trang chủ.</div>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :auction_ends_at, "Kết thúc đấu giá", class: "form-label" %>
              <%= f.datetime_local_field :auction_ends_at, class: "form-control" %>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :bid_increment, "Bước giá tối thiểu (VND)", class: "form-label" %>
              <%= f.number_field :bid_increment, class: "form-control", step: "0.01", placeholder: "VD: 50000" %>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :reserve_price, "Giá dự phòng (tuỳ chọn)", class: "form-label" %>
              <%= f.number_field :reserve_price, class: "form-control", step: "0.01", placeholder: "Không bắt buộc" %>
            </div>

            <div class="col-12">
              <%= f.label :buy_now_price, "Giá mua ngay (tuỳ chọn)", class: "form-label" %>
              <%= f.number_field :buy_now_price, class: "form-control", step: "0.01", placeholder: "VD: 5000000" %>
              <div class="form-text">Nếu nhập giá mua ngay, người mua có thể mua ngay trước khi đấu giá kết thúc.</div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <%= f.submit submit_text, class: "btn btn-primary" %>
            <% if listing.persisted? %>
              <%= link_to "Xem trước", seller_listing_path(listing), class: "btn btn-outline-primary" %>
            <% end %>
          </div>
        </div>
      </div>

      <% if listing.persisted? %>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="fw-semibold mb-2">Kiểm định AI</div>
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted small">Trạng thái</div>
                <div class="fw-semibold"><%= listing.status_text %></div>
              </div>

              <div>
                <%= button_to "Gửi kiểm định AI",
                      submit_ai_verification_seller_listing_path(listing),
                      method: :post,
                      class: "btn btn-outline-secondary",
                      disabled: listing.submitted_for_ai? %>
              </div>
            </div>

            <% if listing.ai_note.present? %>
              <hr>
              <div class="text-muted small mb-1">Ghi chú AI</div>
              <div class="border rounded p-2 bg-light"><%= listing.ai_note %></div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
