<% step = step.to_i %>

<div class="mb-3">
  <div class="small text-muted">Bước <%= step %>/3</div>
  <h1 class="h3 mb-2">
    <%=
      case step
      when 1 then "Thông tin cơ bản"
      when 2 then "Hình ảnh sản phẩm"
      else "Thiết lập bán hàng"
      end
    %>
  </h1>

  <div class="progress" role="progressbar" aria-valuenow="<%= step %>" aria-valuemin="1" aria-valuemax="3">
    <div class="progress-bar" style="width:<%= (step * 100 / 3) %>%"></div>
  </div>
</div>

<%= form_with model: listing, url: url, method: method, multipart: true do |f| %>
  <%= hidden_field_tag :step, step %>

  <% if listing.errors.any? %>
    <div class="alert alert-danger">
      <div class="fw-semibold mb-1">Có lỗi:</div>
      <ul class="mb-0">
        <% listing.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% if step == 1 %>
    <div class="card shadow-sm">
      <div class="card-body">
        
        <div class="mb-4 p-3 bg-light rounded border">
          <%= f.label :reference_item_id, "Bước quan trọng: Chọn loại túi", class: "form-label fw-bold" %>
          <%= f.collection_select :reference_item_id, 
                ReferenceItem.all, :id, :name, 
                { prompt: "-- Chọn mẫu túi từ hệ thống --" }, 
                { class: "form-select" } %>
          <div class="form-text">Nếu không tìm thấy, hãy để trống (AI sẽ kiểm tra theo mô tả chung).</div>
        </div>
        <div class="mb-3">
          <%= f.label :title, "Tên sản phẩm", class: "form-label" %>
          <%= f.text_field :title, class: "form-control", placeholder: "VD: Túi xách vintage..." %>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <%= f.label :category, "Danh mục", class: "form-label" %>
            <%= f.text_field :category, class: "form-control", placeholder: "VD: Thời trang, Điện tử..." %>
          </div>

          <div class="col-12 col-md-6">
            <%= f.label :condition, "Tình trạng", class: "form-label" %>
            <%= f.select :condition,
                  options_for_select([["Mới", "new"], ["Đã sử dụng", "used"]], listing.condition),
                  { include_blank: "Chọn tình trạng" },
                  class: "form-select" %>
          </div>
        </div>

        <div class="mt-3">
          <%= f.label :seller_note, "Mô tả chi tiết", class: "form-label" %>
          <%= f.text_area :seller_note, rows: 6, class: "form-control", placeholder: "Mô tả sản phẩm và phụ kiện đi kèm..." %>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-3">
      <%= f.submit "Tiếp tục", class: "btn btn-primary" %>
    </div>

  <% elsif step == 2 %>
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="border rounded-4 p-4 text-center bg-light">
          <div class="fw-semibold mb-1">Hình ảnh sản phẩm</div>
          <div class="text-muted small mb-3">Kéo thả hoặc bấm để tải ảnh lên (tối thiểu 1, tối đa 5).</div>

          <%= f.file_field :images, multiple: true, class: "form-control" %>
        </div>

        <% if listing.images.attached? %>
          <hr>
          <div class="row g-2">
            <% listing.images.each do |img| %>
              <div class="col-4 col-md-3">
                <%= image_tag img.variant(resize_to_limit: [400, 400]), class: "img-fluid rounded border" %>
              </div>
            <% end %>
          </div>
          <div class="text-muted small mt-2">
            (Xoá ảnh: làm sau, nếu cần mình thêm UI xoá từng ảnh.)
          </div>
        <% end %>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-3">
      <%= link_to "Quay lại", edit_seller_listing_path(listing, step: 1), class: "btn btn-outline-secondary" %>
      <%= f.submit "Tiếp tục", class: "btn btn-primary" %>
    </div>

  <% else %>
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <div class="fw-semibold mb-2">Chọn chế độ bán</div>
          <div class="d-flex gap-2 flex-wrap">
            <span class="badge text-bg-light border">Đấu giá</span>
            <span class="badge text-bg-light border">Mua ngay</span>
            <span class="text-muted small">(Bạn có thể cấu hình cả 2)</span>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <%= f.label :start_price, "Giá khởi điểm (VND)", class: "form-label" %>
            <%= f.number_field :start_price, class: "form-control", step: "0.01", placeholder: "VD: 1000000" %>
          </div>

          <div class="col-12 col-md-6">
            <%= f.label :auction_ends_at, "Thời điểm kết thúc đấu giá", class: "form-label" %>
            <%= f.datetime_local_field :auction_ends_at, class: "form-control" %>
          </div>

          <div class="col-12 col-md-6">
            <%= f.label :bid_increment, "Bước giá tối thiểu (VND)", class: "form-label" %>
            <%= f.number_field :bid_increment, class: "form-control", step: "0.01", placeholder: "VD: 50000" %>
          </div>

          <div class="col-12 col-md-6">
            <%= f.label :reserve_price, "Giá dự phòng (tuỳ chọn)", class: "form-label" %>
            <%= f.number_field :reserve_price, class: "form-control", step: "0.01", placeholder: "Không bắt buộc" %>
          </div>

          <div class="col-12">
            <%= f.label :buy_now_price, "Giá mua ngay (tuỳ chọn)", class: "form-label" %>
            <%= f.number_field :buy_now_price, class: "form-control", step: "0.01", placeholder: "VD: 5000000" %>
            <div class="form-text">Nếu nhập giá mua ngay, người mua có thể mua ngay trước khi đấu giá kết thúc.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-3">
      <%= link_to "Quay lại", edit_seller_listing_path(listing, step: 2), class: "btn btn-outline-secondary" %>
      <div class="d-flex gap-2">
        <%= link_to "Xem trước", seller_listing_path(listing), class: "btn btn-outline-primary" %>
        <%= f.submit "Hoàn tất", class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>
<% end %>
