<div class="dropdown position-relative" data-controller="dropdown">
  <button
    class="btn btn-light position-relative rounded-pill border"
    type="button"
    data-notifications-dropdown-target="button"
    data-action="click->dropdown#toggle"
    aria-expanded="false"
    style="width:40px;height:40px;"
  >
    <i class="bi bi-bell"></i>

    <% unread_count = current_user.notifications.unread.count rescue 0 %>
    <% if unread_count > 0 %>
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        <%= unread_count > 99 ? "99+" : unread_count %>
      </span>
    <% end %>
  </button>

  <div
    class="dropdown-menu dropdown-menu-end notifications-menu p-0 shadow-lg border-0"
    data-dropdown-target="menu"
    style="width:min(420px, 92vw); border-radius:16px; overflow:hidden;"
  >
    <div class="d-flex align-items-center justify-content-between px-3 py-3 bg-white border-bottom">
      <div class="fw-semibold">Thông báo</div>
      <div class="d-flex gap-2">
        <%= link_to "Xem tất cả", notifications_path, class: "btn btn-sm btn-outline-primary rounded-pill" %>
      </div>
    </div>

    <div class="bg-white" style="max-height: 420px; overflow:auto;">
      <% notifications = (current_user.notifications.order(created_at: :desc).limit(8) rescue []) %>

      <% if notifications.blank? %>
        <div class="p-3 text-muted">Chưa có thông báo.</div>
      <% else %>
        <div class="list-group list-group-flush">
          <% notifications.each do |n| %>
            <% is_unread = n.read_at.blank? rescue true %>

            <a
              href="<%= n.url.presence || notifications_path %>"
              class="list-group-item list-group-item-action d-flex gap-3 align-items-start"
              style="<%= is_unread ? "background:#f5f9ff;" : "" %>"
            >
              <div class="mt-1">
                <span class="d-inline-flex align-items-center justify-content-center rounded-circle"
                      style="width:32px;height:32px;background:<%= is_unread ? "#e7f1ff" : "#f2f2f2" %>;">
                  <i class="bi <%= is_unread ? "bi-dot" : "bi-check2" %>"></i>
                </span>
              </div>

              <div class="flex-grow-1">
                <div class="<%= is_unread ? "fw-semibold" : "" %>">
                  <%= n.message %>
                </div>
                <div class="text-muted small mt-1">
                  <%= l(n.created_at, format: :short) rescue "" %>
                </div>
              </div>

              <% if is_unread %>
                <span class="badge text-bg-primary rounded-pill">Mới</span>
              <% end %>
            </a>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="px-3 py-2 bg-white border-top d-flex justify-content-between">
      <%= button_to "Đánh dấu tất cả đã đọc",
            mark_all_read_notifications_path,
            method: :post,
            class: "btn btn-sm btn-outline-secondary rounded-pill",
            form: { data: { turbo: false } } %>

      <%= link_to "Quản lý", notifications_path, class: "btn btn-sm btn-primary rounded-pill" %>
    </div>
  </div>
</div>
