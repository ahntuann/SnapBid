service: snapbid
image: ahntuan/snapbid

servers:
  web:
    hosts:
      - 103.200.23.123

proxy:
  app_port: 3000
  healthcheck:
    path: /up
    interval: 5

# Bắt buộc cho chip Intel/AMD trên VPS
builder:
  arch: amd64

registry:
  server: index.docker.io
  username: ahntuan
  # Đọc token từ file .env
  password: <%= ENV["KAMAL_REGISTRY_PASSWORD"] %>

env:
  clear:
    # Cấu hình Database & Redis
    DB_HOST: snapbid-db
    REDIS_URL: redis://snapbid-redis:6379/1

    # Các biến cấu hình chung
    ADMIN_QR_PAYLOAD: "BANK:XXX|ACC:123456789|NAME:SNAPBID ADMIN"
    AI_MOCK: "false"
    APP_HOST: "snapbid.io.vn"
    RAILS_SERVE_STATIC_FILES: "true"
    WEB_CONCURRENCY: "2"

    # Cấu hình Mail & QR
    MAIL_FROM: "thieuphong2402@gmail.com"
    SMTP_USER: "a079f2001@smtp-brevo.com"
    VIETQR_ACCOUNT: "00000103607"
    VIETQR_BANK: "TPB"
    VIETQR_NAME: "BUI THI THANH VAN"

    # --- CÁC BIẾN MẬT LẤY TỪ FILE .ENV ---
    POSTGRES_PASSWORD: <%= ENV["POSTGRES_PASSWORD"] %>
    RAILS_MASTER_KEY: <%= ENV["RAILS_MASTER_KEY"] %>
    CLOUDINARY_URL: <%= ENV["CLOUDINARY_URL"] %>
    GOOGLE_CLIENT_ID: <%= ENV["GOOGLE_CLIENT_ID"] %>
    GOOGLE_CLIENT_SECRET: <%= ENV["GOOGLE_CLIENT_SECRET"] %>
    OPENAI_API_KEY: <%= ENV["OPENAI_API_KEY"] %>
    SMTP_PASS: <%= ENV["SMTP_PASS"] %>

accessories:
  db:
    image: postgres:16
    host: 103.200.23.123
    # QUAN TRỌNG NHẤT: Thêm 127.0.0.1 vào trước để KHÓA CỬA, chỉ cho nội bộ VPS vào
    port: "127.0.0.1:5432:5432"
    env:
      clear:
        POSTGRES_USER: postgres
        POSTGRES_DB: snapbid_production
        POSTGRES_PASSWORD: <%= ENV["POSTGRES_PASSWORD"] %>
    directories:
      - data:/var/lib/postgresql/data

  redis:
    image: redis:alpine
    host: 103.200.23.123
    # Cũng khóa Redis lại luôn cho chắc
    port: "127.0.0.1:6379:6379"
    directories:
      - data:/data
